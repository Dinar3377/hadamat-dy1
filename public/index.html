<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f2f2f2;
    }

    #map {
      height: calc(100% - 90px);
    }

    .controls {
      height: 90px;
      display: flex;
      gap: 10px;
      padding: 12px;
      background: #ffffff;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.12);
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }

    .btn {
      flex: 1;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:active { transform: scale(0.96); }

    .btn-location { background: #e3f2fd; color: #0d47a1; }
    .btn-clear { background: #ffebee; color: #b71c1c; }
    .btn-order {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,200,83,0.4);
    }
    .btn-order:disabled { background: #bdbdbd; box-shadow: none; }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button class="btn btn-location" onclick="setMyLocation()">üìç –ú–æ—ë –º–µ—Å—Ç–æ</button>
  <button class="btn btn-clear" onclick="clearPoints()">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
  <button class="btn btn-order" id="orderBtn" onclick="sendOrder()" disabled>‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const CENTER = [55.4842, 54.8526];
  const map = L.map('map').setView(CENTER, 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let pointA = null, pointB = null;
  let markerA = null, markerB = null;
  let routeControl = null;
  let distanceKm = 0;
  let geoRequested = false;

  const orderBtn = document.getElementById("orderBtn");

  map.on('click', (e) => {
    if (!pointA) {
      pointA = e.latlng;
      markerA = L.marker(pointA).addTo(map).bindPopup("–¢–æ—á–∫–∞ A").openPopup();
    } else if (!pointB) {
      pointB = e.latlng;
      markerB = L.marker(pointB).addTo(map).bindPopup("–¢–æ—á–∫–∞ B").openPopup();
      buildRoute();
    }
  });

  function setMyLocation() {
    if (geoRequested) {
      tg.showPopup({
        title: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è",
        message: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞—Å—å.\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –≤—Ä—É—á–Ω—É—é –Ω–∞ –∫–∞—Ä—Ç–µ.",
        buttons: [{ type: "ok" }]
      });
      return;
    }

    geoRequested = true;

    map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true });

    map.once('locationfound', (e) => {
      clearPoints();
      pointA = e.latlng;
      markerA = L.marker(pointA)
        .addTo(map)
        .bindPopup("üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ")
        .openPopup();
    });

    map.once('locationerror', () => {
      tg.showPopup({
        title: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞",
        message:
          "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n" +
          "‚Ä¢ WebApp –æ—Ç–∫—Ä—ã—Ç –∏–∑ Telegram\n" +
          "‚Ä¢ —Ä–∞–∑—Ä–µ—à—ë–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏\n" +
          "‚Ä¢ GPS –≤–∫–ª—é—á—ë–Ω",
        buttons: [{ type: "ok" }]
      });
    });
  }

  function buildRoute() {
    if (routeControl) map.removeControl(routeControl);

    routeControl = L.Routing.control({
      waypoints: [
        L.latLng(pointA.lat, pointA.lng),
        L.latLng(pointB.lat, pointB.lng)
      ],
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      show: false
    })
    .on('routesfound', function (e) {
      distanceKm = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
      orderBtn.disabled = false;

      tg.showPopup({
        title: "–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω",
        message: `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceKm} –∫–º`,
        buttons: [{ type: "ok" }]
      });
    })
    .addTo(map);
  }

  function clearPoints() {
    if (markerA) map.removeLayer(markerA);
    if (markerB) map.removeLayer(markerB);
    if (routeControl) map.removeControl(routeControl);

    pointA = pointB = null;
    markerA = markerB = null;
    routeControl = null;
    distanceKm = 0;
    orderBtn.disabled = true;
  }

  function sendOrder() {
    if (!pointA || !pointB) return;

    orderBtn.disabled = true; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞

    tg.sendData(JSON.stringify({
      from: pointA,
      to: pointB,
      distance_km: distanceKm
    }));

    // üî• –í–ê–ñ–ù–û: –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp
    tg.close();
  }
</script>

</body>
</html>
