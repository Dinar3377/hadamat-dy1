<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f2f2f2;
    }

    #map {
      height: calc(100% - 90px);
    }

    .controls {
      height: 90px;
      display: flex;
      gap: 10px;
      padding: 12px;
      background: #ffffff;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.12);
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }

    .btn {
      flex: 1;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:active { transform: scale(0.96); }

    .btn-location { background: #e3f2fd; color: #0d47a1; }
    .btn-clear { background: #ffebee; color: #b71c1c; }
    .btn-order {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,200,83,0.4);
    }
    .btn-order:disabled { 
      background: #bdbdbd; 
      box-shadow: none; 
      cursor: not-allowed;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button class="btn btn-location" onclick="setMyLocation()">üìç –ú–æ—ë –º–µ—Å—Ç–æ</button>
  <button class="btn btn-clear" onclick="clearPoints()">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
  <button class="btn btn-order" id="orderBtn" onclick="sendOrder()" disabled>‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
  let tg;
  try {
    tg = window.Telegram?.WebApp;
    if (!tg) {
      console.error("Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
      // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      tg = {
        expand: () => console.log("expand"),
        sendData: (data) => {
          console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", data);
          return true;
        },
        close: () => console.log("close"),
        showPopup: (params) => {
          alert(params.title + ": " + params.message);
        },
        ready: () => console.log("ready"),
        initDataUnsafe: { user: {} }
      };
    } else {
      tg.expand();
      tg.ready();
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:", e);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  const CENTER = [55.4842, 54.8526];
  const map = L.map('map').setView(CENTER, 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let pointA = null, pointB = null;
  let markerA = null, markerB = null;
  let routeControl = null;
  let distanceKm = 0;
  let geoRequested = false;
  let isSending = false;

  const orderBtn = document.getElementById("orderBtn");

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
  map.on('click', (e) => {
    if (!pointA) {
      pointA = e.latlng;
      markerA = L.marker(pointA).addTo(map).bindPopup("–¢–æ—á–∫–∞ A").openPopup();
    } else if (!pointB) {
      pointB = e.latlng;
      markerB = L.marker(pointB).addTo(map).bindPopup("–¢–æ—á–∫–∞ B").openPopup();
      buildRoute();
    }
  });

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
  function setMyLocation() {
    if (geoRequested) {
      showAlert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è", "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞—Å—å.\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –≤—Ä—É—á–Ω—É—é –Ω–∞ –∫–∞—Ä—Ç–µ.");
      return;
    }

    geoRequested = true;

    map.locate({ 
      setView: true, 
      maxZoom: 16, 
      enableHighAccuracy: true,
      timeout: 10000 
    });

    map.once('locationfound', (e) => {
      clearPoints();
      pointA = e.latlng;
      markerA = L.marker(pointA)
        .addTo(map)
        .bindPopup("üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ")
        .openPopup();
      showAlert("–£—Å–ø–µ—Ö", "–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ!");
    });

    map.once('locationerror', (e) => {
      console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", e.message);
      showAlert(
        "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞",
        "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n" +
        "‚Ä¢ –†–∞–∑—Ä–µ—à—ë–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏\n" +
        "‚Ä¢ GPS –≤–∫–ª—é—á—ë–Ω\n" +
        "‚Ä¢ –ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –≤—Ä—É—á–Ω—É—é"
      );
      geoRequested = false;
    });
  }

  // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
  function buildRoute() {
    if (routeControl) {
      map.removeControl(routeControl);
    }

    routeControl = L.Routing.control({
      waypoints: [
        L.latLng(pointA.lat, pointA.lng),
        L.latLng(pointB.lat, pointB.lng)
      ],
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      show: false,
      createMarker: () => null,
      lineOptions: {
        styles: [{ color: '#2196F3', weight: 4, opacity: 0.7 }]
      }
    });

    routeControl.on('routesfound', function (e) {
      if (e.routes && e.routes[0]) {
        distanceKm = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
        orderBtn.disabled = false;
        
        showAlert("–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω", `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceKm} –∫–º`);
      }
    });

    routeControl.on('routingerror', function (e) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:", e);
      showAlert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç");
    });

    routeControl.addTo(map);
  }

  // –û—á–∏—Å—Ç–∫–∞ —Ç–æ—á–µ–∫
  function clearPoints() {
    if (markerA) map.removeLayer(markerA);
    if (markerB) map.removeLayer(markerB);
    if (routeControl) {
      map.removeControl(routeControl);
      routeControl = null;
    }

    pointA = pointB = null;
    markerA = markerB = null;
    distanceKm = 0;
    orderBtn.disabled = true;
    isSending = false;
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
  function sendOrder() {
    if (!pointA || !pointB || isSending) {
      return;
    }

    isSending = true;
    orderBtn.disabled = true;
    orderBtn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

    const orderData = {
      from: {
        lat: pointA.lat.toFixed(6),
        lng: pointA.lng.toFixed(6)
      },
      to: {
        lat: pointB.lat.toFixed(6),
        lng: pointB.lng.toFixed(6)
      },
      distance_km: distanceKm,
      timestamp: Date.now(),
      user_id: tg?.initDataUnsafe?.user?.id || "unknown"
    };

    console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", orderData);

    try {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram –±–æ—Ç–∞
      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(orderData));
        showAlert("–£—Å–ø–µ—Ö", "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ —Ç–∞–∫—Å–∏.");
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          if (tg.close) {
            tg.close();
          } else {
            showAlert("–ì–æ—Ç–æ–≤–æ", "–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –≤—Ä—É—á–Ω—É—é.");
          }
        }, 2000);
      } else {
        throw new Error("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
      showAlert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
      orderBtn.disabled = false;
      orderBtn.textContent = "‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å";
      isSending = false;
    }
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function showAlert(title, message) {
    if (tg && tg.showPopup) {
      tg.showPopup({
        title: title,
        message: message,
        buttons: [{ type: "ok", id: "ok" }]
      });
    } else {
      alert(title + ": " + message);
    }
  }

  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
  if (!window.Telegram) {
    console.warn("–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–Ω–µ –≤ Telegram)");
    showAlert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞");
  }
</script>

</body>
</html>
