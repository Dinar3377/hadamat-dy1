<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- üîë –Ø–ù–î–ï–ö–° –ö–ê–†–¢–´ -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=dc353f10-1df9-4896-9b73-8735276c0348&lang=ru_RU"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: calc(100% - 90px);
    }
    .controls {
      height: 90px;
      display: flex;
      gap: 10px;
      padding: 12px;
      background: #fff;
    }
    button {
      flex: 1;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
    }
    .order {
      background: #00c853;
      color: #fff;
    }
    .order:disabled {
      background: #bbb;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button id="clear">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
  <button id="order" class="order" disabled>‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

let map;
let pointA = null;
let pointB = null;
let route = null;

ymaps.ready(() => {
  map = new ymaps.Map("map", {
    center: [55.75, 37.61],
    zoom: 13,
    controls: ["zoomControl"]
  });

  map.events.add("click", (e) => {
    const coords = e.get("coords");

    if (!pointA) {
      pointA = new ymaps.Placemark(coords, { balloonContent: "–û—Ç–∫—É–¥–∞" });
      map.geoObjects.add(pointA);
    } else if (!pointB) {
      pointB = new ymaps.Placemark(coords, { balloonContent: "–ö—É–¥–∞" });
      map.geoObjects.add(pointB);
      buildRoute();
    }
  });
});

function buildRoute() {
  if (route) map.geoObjects.remove(route);

  route = new ymaps.multiRouter.MultiRoute({
    referencePoints: [
      pointA.geometry.getCoordinates(),
      pointB.geometry.getCoordinates()
    ],
    params: {
      routingMode: "auto"
    }
  }, {
    boundsAutoApply: true
  });

  route.model.events.add("requestsuccess", () => {
    document.getElementById("order").disabled = false;
  });

  map.geoObjects.add(route);
}

document.getElementById("clear").onclick = () => {
  map.geoObjects.removeAll();
  pointA = pointB = route = null;
  document.getElementById("order").disabled = true;
};

document.getElementById("order").onclick = () => {
  const distance =
    route.model.getRoutes()[0].properties.get("distance").value / 1000;

  tg.sendData(JSON.stringify({
    from: pointA.geometry.getCoordinates(),
    to: pointB.geometry.getCoordinates(),
    distance_km: distance.toFixed(2)
  }));

  tg.close();
};
</script>

</body>
</html>
