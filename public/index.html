<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Hadamat Taxi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 130px;
    }

    #panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 0 12px rgba(0,0,0,0.25);
      z-index: 9999;
    }

    .row {
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:active {
      transform: scale(0.98);
    }

    #locate {
      background: #e3f2fd;
      color: #0d47a1;
    }

    #clear {
      background: #ffebee;
      color: #b71c1c;
    }

    #send {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: white;
      box-shadow: 0 4px 15px rgba(0,200,83,0.3);
    }

    #send:disabled {
      background: #cccccc;
      box-shadow: none;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <div id="a" class="row">üìç –¢–æ—á–∫–∞ A: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
  <div id="b" class="row">üèÅ –¢–æ—á–∫–∞ B: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
  <div id="dist" class="row">üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</div>

  <div class="buttons">
    <button id="locate">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
    <button id="clear">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
    <button id="send" disabled>üöï –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>
</div>

<script>
  // ============================================================
  // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
  // ============================================================
  
  // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp
    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
      const tg = Telegram.WebApp;
      
      // üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
      tg.ready();
      tg.expand();
      
      // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
      tg.enableClosingConfirmation();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º tg –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–π
      window.tg = tg;
      
      console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', tg.initDataUnsafe?.user);
    } else {
      console.error('Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!');
      // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      window.tg = {
        sendData: function(data) {
          console.log('üì§ –î–ï–ú–û: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);
          alert('–î–µ–º–æ-—Ä–µ–∂–∏–º: –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: ' + data);
        },
        close: function() {
          console.log('–î–ï–ú–û: –ó–∞–∫—Ä—ã—Ç–∏–µ WebApp');
        },
        showPopup: function(params) {
          alert(params.title + ': ' + params.message);
        }
      };
    }
    
    // –¢–µ–ø–µ—Ä—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    initMap();
  });

  // ============================================================
  // üó∫ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ (–î–Æ–†–¢–Æ–õ–ò)
  // ============================================================
  function initMap() {
    const map = L.map("map").setView([55.4842, 54.8526], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º map –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    window.map = map;
    window.A = null;
    window.B = null;
    window.markerA = null;
    window.markerB = null;
    window.route = null;
    window.distanceKm = null;

    const aEl = document.getElementById("a");
    const bEl = document.getElementById("b");
    const dEl = document.getElementById("dist");
    const sendBtn = document.getElementById("send");

    // ============================================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ============================================================
    
    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
    map.on("click", e => {
      if (!window.A) {
        window.A = e.latlng;
        window.markerA = L.marker(window.A).addTo(map);
        aEl.innerText = `üìç –¢–æ—á–∫–∞ A: ${window.A.lat.toFixed(5)}, ${window.A.lng.toFixed(5)}`;
      } 
      else if (!window.B) {
        window.B = e.latlng;
        window.markerB = L.marker(window.B).addTo(map);
        bEl.innerText = `üèÅ –¢–æ—á–∫–∞ B: ${window.B.lat.toFixed(5)}, ${window.B.lng.toFixed(5)}`;
        buildRoute();
      }
    });

    // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    document.getElementById("locate").onclick = () => {
      map.locate({ 
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });

      map.once("locationfound", e => {
        clearAll();
        window.A = e.latlng;
        window.markerA = L.marker(window.A).addTo(map);
        aEl.innerText = `üìç –¢–æ—á–∫–∞ A (–º–æ–π –∞–¥—Ä–µ—Å): ${window.A.lat.toFixed(5)}, ${window.A.lng.toFixed(5)}`;
        map.setView(window.A, 15);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (window.tg && window.tg.showPopup) {
          window.tg.showPopup({
            title: "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
            message: "–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ —Ç–æ—á–∫–∞ –ê",
            buttons: [{ type: "ok" }]
          });
        }
      });

      map.once("locationerror", e => {
        console.error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:", e.message);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ.");
      });
    };

    // –û—á–∏—Å—Ç–∫–∞
    document.getElementById("clear").onclick = clearAll;

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
    sendBtn.onclick = sendOrder;
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
    window.buildRoute = function() {
      if (window.route) map.removeControl(window.route);

      window.route = L.Routing.control({
        waypoints: [
          L.latLng(window.A.lat, window.A.lng),
          L.latLng(window.B.lat, window.B.lng)
        ],
        addWaypoints: false,
        draggableWaypoints: false,
        show: false,
        lineOptions: {
          styles: [{ color: '#2196F3', weight: 4, opacity: 0.7 }]
        }
      })
      .on("routesfound", e => {
        if (e.routes && e.routes[0]) {
          window.distanceKm = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
          dEl.innerText = `üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${window.distanceKm} –∫–º`;
          sendBtn.disabled = false;
          
          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
          if (window.tg && window.tg.showPopup) {
            window.tg.showPopup({
              title: "–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω",
              message: `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${window.distanceKm} –∫–º`,
              buttons: [{ type: "ok" }]
            });
          }
        }
      })
      .on("routingerror", e => {
        console.error("–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–∫–∏.");
      })
      .addTo(map);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏
    window.clearAll = function() {
      if (window.markerA) map.removeLayer(window.markerA);
      if (window.markerB) map.removeLayer(window.markerB);
      if (window.route) map.removeControl(window.route);

      window.A = window.B = window.markerA = window.markerB = window.route = window.distanceKm = null;
      aEl.innerText = "üìç –¢–æ—á–∫–∞ A: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
      bEl.innerText = "üèÅ –¢–æ—á–∫–∞ B: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
      dEl.innerText = "üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ‚Äî";
      sendBtn.disabled = true;
    };
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    window.sendOrder = function() {
      if (!window.A || !window.B || !window.distanceKm) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞!");
        return;
      }

      // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
      const payload = {
        from: { 
          lat: window.A.lat.toFixed(6), 
          lng: window.A.lng.toFixed(6) 
        },
        to: { 
          lat: window.B.lat.toFixed(6), 
          lng: window.B.lng.toFixed(6) 
        },
        distance_km: window.distanceKm,
        timestamp: new Date().toISOString(),
        user_id: window.tg?.initDataUnsafe?.user?.id || "unknown",
        username: window.tg?.initDataUnsafe?.user?.username || "–ë–µ–∑ –∏–º–µ–Ω–∏"
      };

      console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", payload);

      try {
        // üî• –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp
        window.tg.sendData(JSON.stringify(payload));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (window.tg.showPopup) {
          window.tg.showPopup({
            title: "‚úÖ –£—Å–ø–µ—à–Ω–æ!",
            message: "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ —Ç–∞–∫—Å–∏.",
            buttons: [{ type: "ok" }]
          }, function(btnId) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è OK
            setTimeout(() => {
              if (window.tg.close) {
                window.tg.close();
              }
            }, 500);
          });
        } else {
          alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ.");
          setTimeout(() => {
            if (window.tg.close) window.tg.close();
          }, 1500);
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
        sendBtn.disabled = true;
        sendBtn.textContent = "üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ...";
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞: " + error.message);
      }
    };
  }
</script>

</body>
</html>
