<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Yandex Maps -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=dc353f10-1df9-4896-9b73-8735276c0348&lang=ru_RU"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: Arial, sans-serif;
}

#map {
  height: calc(100% - 110px);
}

.controls {
  height: 110px;
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #fff;
  box-sizing: border-box;
}

button {
  flex: 1;
  font-size: 15px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}

.locate { background: #e3f2fd; }
.clear  { background: #ffebee; }
.order  { background: #00c853; color: #fff; }

.order:disabled {
  background: #aaa;
  cursor: not-allowed;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button class="locate" id="locateBtn">üìç –ú–æ—ë –º–µ—Å—Ç–æ</button>
  <button class="clear"  id="clearBtn">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
  <button class="order"  id="orderBtn" disabled>‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

ymaps.ready(init);

let map;
let pointA = null;
let pointB = null;
let route = null;

function init() {
  map = new ymaps.Map("map", {
    center: [55.751244, 37.618423], // —Ü–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    zoom: 13
  });

  map.events.add('click', function (e) {
    const coords = e.get('coords');

    if (!pointA) {
      setPointA(coords);
    } else if (!pointB) {
      setPointB(coords);
      buildRoute();
    }
  });
}

// ---------- –¢–û–ß–ö–ò ----------
function setPointA(coords) {
  if (pointA) map.geoObjects.remove(pointA);
  pointA = new ymaps.Placemark(
    coords,
    { balloonContent: "–û—Ç–∫—É–¥–∞" },
    { preset: "islands#greenIcon" }
  );
  map.geoObjects.add(pointA);
}

function setPointB(coords) {
  if (pointB) map.geoObjects.remove(pointB);
  pointB = new ymaps.Placemark(
    coords,
    { balloonContent: "–ö—É–¥–∞" },
    { preset: "islands#blueIcon" }
  );
  map.geoObjects.add(pointB);
}

// ---------- –ú–ê–†–®–†–£–¢ ----------
function buildRoute() {
  if (route) map.geoObjects.remove(route);

  ymaps.route(
    [
      pointA.geometry.getCoordinates(),
      pointB.geometry.getCoordinates()
    ],
    { routingMode: "auto" }
  ).then(function (r) {
    route = r;
    map.geoObjects.add(route);
    document.getElementById("orderBtn").disabled = false;
  }, function () {
    alert("‚ùå –ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ –±–ª–∏–∂–µ –∫ –¥–æ—Ä–æ–≥–µ.");
  });
}

// ---------- –ö–ù–û–ü–ö–ò ----------

// üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
document.getElementById("locateBtn").onclick = () => {
  ymaps.geolocation.get({ provider: 'auto' }).then(res => {
    const coords = res.geoObjects.get(0).geometry.getCoordinates();
    map.setCenter(coords, 16);
    setPointA(coords);
  }, () => {
    alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
  });
};

// ‚ùå –û—á–∏—Å—Ç–∏—Ç—å
document.getElementById("clearBtn").onclick = () => {
  map.geoObjects.removeAll();
  pointA = null;
  pointB = null;
  route = null;
  document.getElementById("orderBtn").disabled = true;
};

// ‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å
document.getElementById("orderBtn").onclick = () => {
  if (!pointA || !pointB || !route) {
    alert("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç");
    return;
  }

  const distanceKm = route.getLength() / 1000;

  const payload = {
    type: "client_route",                 // üî• –ö–õ–Æ–ß–ï–í–û –î–õ–Ø –ë–û–¢–ê
    from: pointA.geometry.getCoordinates(),
    to: pointB.geometry.getCoordinates(),
    distance_km: Number(distanceKm.toFixed(2))
  };

  console.log("üì§ SEND TO BOT:", payload);

  tg.sendData(JSON.stringify(payload));
  tg.close();
};
</script>

</body>
</html>
