<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Taxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<style>
html,body{margin:0;height:100%}
#map{height:calc(100% - 90px)}
.controls{height:90px;display:flex;gap:10px;padding:12px;background:#fff}
.btn{flex:1;border-radius:12px;border:none;font-weight:600}
.btn-order{background:#00c853;color:#fff}
</style>
</head>

<body>

<div id="map"></div>
<div class="controls">
  <button class="btn" id="clear">❌ Очистить</button>
  <button class="btn btn-order" id="order" disabled>✅ Заказать</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.expand(); tg.ready();

const map = L.map('map').setView([55.75,37.61],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let points = [];
let control = null;

map.on('click', e=>{
  points.push(e.latlng);

  if(points.length === 2){
    if(control) map.removeControl(control);

    control = L.Routing.control({
      waypoints: points,
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: true,
      router: L.Routing.osrmv1({
        serviceUrl: 'https://routing.openstreetmap.de/routed-car/' // ❗ НЕ public OSRM
      }),
      lineOptions:{
        styles:[{color:'#1e88e5',weight:5}]
      }
    }).addTo(map);

    document.getElementById('order').disabled = false;
  }
});

document.getElementById('clear').onclick=()=>{
  points=[];
  if(control) map.removeControl(control);
  document.getElementById('order').disabled = true;
};

document.getElementById('order').onclick=()=>{
  tg.sendData(JSON.stringify({
    from: points[0],
    to: points[1]
  }));
  tg.close();
};
</script>

</body>
</html>
