<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Taxi Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: calc(100% - 140px);
      width: 100%;
    }

    #panel {
      height: 140px;
      padding: 10px;
      background: #fff;
      box-shadow: 0 -2px 10px rgba(0,0,0,.3);
    }

    .row {
      font-size: 15px;
      margin-bottom: 4px;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      background: #00c853;
      color: white;
      border: none;
      border-radius: 8px;
      margin-top: 6px;
    }

    button:disabled {
      background: #aaa;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <div class="row" id="a">üìç –¢–æ—á–∫–∞ A: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
  <div class="row" id="b">üèÅ –¢–æ—á–∫–∞ B: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>
  <div class="row" id="d">üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</div>
  <button id="send" disabled>üöï –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  let map;
  let markerA = null;
  let markerB = null;
  let A = null;
  let B = null;
  let distanceKm = null;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 13,
      center: { lat: 55.4842, lng: 54.8526 }, // –î—é—Ä—Ç—é–ª–∏
    });

    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true
    });
    directionsRenderer.setMap(map);

    map.addListener("click", (e) => {
      if (!A) {
        A = e.latLng;
        markerA = new google.maps.Marker({
          position: A,
          map,
          label: "A"
        });
        document.getElementById("a").innerText =
          `üìç –¢–æ—á–∫–∞ A: ${A.lat().toFixed(5)}, ${A.lng().toFixed(5)}`;
      }
      else if (!B) {
        B = e.latLng;
        markerB = new google.maps.Marker({
          position: B,
          map,
          label: "B"
        });
        document.getElementById("b").innerText =
          `üèÅ –¢–æ—á–∫–∞ B: ${B.lat().toFixed(5)}, ${B.lng().toFixed(5)}`;

        directionsService.route({
          origin: A,
          destination: B,
          travelMode: google.maps.TravelMode.DRIVING
        }, (res, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(res);
            const meters = res.routes[0].legs[0].distance.value;
            distanceKm = (meters / 1000).toFixed(2);
            document.getElementById("d").innerText =
              `üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceKm} –∫–º`;
            document.getElementById("send").disabled = false;
          }
        });
      }
    });

    document.getElementById("send").onclick = () => {
      if (!A || !B) return;

      const data = {
        from: { lat: A.lat(), lng: A.lng() },
        to: { lat: B.lat(), lng: B.lng() },
        distance_km: distanceKm
      };

      tg.sendData(JSON.stringify(data));
      setTimeout(() => tg.close(), 300);
    };
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBO5RQpbrvnBEfchhCGqKTpzvqOjJyf0RI&callback=initMap">
</script>

</body>
</html>
