<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞–∫–∞–∑ —Ç–∞–∫—Å–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height: 100%; }
    #log {
      position: fixed;
      left: 10px;
      right: 10px;
      top: 10px;
      z-index: 9999;
      background: rgba(0,0,0,0.70);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      max-height: 35vh;
      overflow: auto;
      pointer-events: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="log">log...\n</div>

<script>
  const tg = window.Telegram?.WebApp;

  const logBox = document.getElementById("log");
  function log(msg) {
    logBox.textContent += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  if (!tg) {
    alert("‚ùå Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω");
    log("‚ùå tg not found");
  } else {
    tg.ready?.();
    tg.expand?.();

    log("‚úÖ tg found");
    log("initData length: " + (tg.initData ? tg.initData.length : 0));
    log("platform: " + (tg.platform || "unknown"));
    log("version: " + (tg.version || "unknown"));
  }

  // --- MainButton: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å ---
  tg.MainButton.setText("üöï –ù–∞–∂–º–∏ —Å—é–¥–∞ (—Ç–µ—Å—Ç)");
  tg.MainButton.show();
  tg.MainButton.enable();  // ‚ö†Ô∏è –í–ê–ñ–ù–û: –Ω–µ disabled

  // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ---
  const CENTER = [55.4842, 54.8526];
  const map = L.map('map').setView(CENTER, 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let pointA = null, pointB = null;
  let markerA = null, markerB = null;
  let routeControl = null;
  let distanceKm = "";

  map.on('click', (e) => {
    if (!pointA) {
      pointA = e.latlng;
      markerA = L.marker(pointA).addTo(map).bindPopup("üìç –¢–æ—á–∫–∞ A").openPopup();
      tg.MainButton.setText("–í—ã–±–µ—Ä–∏ —Ç–æ—á–∫—É B");
      log("A set: " + pointA.lat + "," + pointA.lng);
    } else if (!pointB) {
      pointB = e.latlng;
      markerB = L.marker(pointB).addTo(map).bindPopup("üèÅ –¢–æ—á–∫–∞ B").openPopup();
      tg.MainButton.setText("–°—Ç—Ä–æ—é –º–∞—Ä—à—Ä—É—Ç...");
      log("B set: " + pointB.lat + "," + pointB.lng);
      buildRoute();
    }
  });

  function buildRoute() {
    try {
      if (routeControl) map.removeControl(routeControl);

      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(pointA.lat, pointA.lng),
          L.latLng(pointB.lat, pointB.lng)
        ],
        addWaypoints: false,
        draggableWaypoints: false,
        routeWhileDragging: false,
        show: false
      })
      .on('routesfound', (e) => {
        distanceKm = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
        tg.MainButton.setText("üöï –ó–∞–∫–∞–∑–∞—Ç—å (" + distanceKm + " –∫–º)");
        tg.MainButton.enable();
        log("‚úÖ route found, km=" + distanceKm);
        tg.showAlert?.("–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω: " + distanceKm + " –∫–º");
      })
      .on('routingerror', (err) => {
        log("‚ùå routingerror: " + JSON.stringify(err));
        tg.MainButton.setText("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω");
        tg.showAlert?.("‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞");
      })
      .addTo(map);

    } catch (e) {
      log("‚ùå buildRoute exception: " + (e?.message || e));
      tg.showAlert?.("‚ùå –û—à–∏–±–∫–∞ buildRoute");
    }
  }

  // --- –ö–ª–∏–∫ –ø–æ MainButton: –ø–æ–¥–ø–∏—Å–∫–∞ –î–í–£–ú–Ø —Å–ø–æ—Å–æ–±–∞–º–∏ ---
  function handleMainButtonClick(src) {
    log("üî• MainButton click from: " + src);

    // 1) –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –∞–ª–µ—Ä—Ç –≤—Å–µ–≥–¥–∞ ‚Äî –µ—Å–ª–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–ª–∏–∫ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –ª–æ–≤–∏—Ç—Å—è
    tg.showAlert?.("‚úÖ –ö–ª–∏–∫ –ø–æ–π–º–∞–Ω (" + src + ")");

    // 2) –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ—á–µ–º—É
    if (!pointA || !pointB) {
      tg.showAlert?.("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ A –∏ B –Ω–∞ –∫–∞—Ä—Ç–µ");
      return;
    }

    const payload = {
      from: { lat: pointA.lat, lng: pointA.lng },
      to: { lat: pointB.lat, lng: pointB.lng },
      distance_km: distanceKm || "0"
    };

    log("‚û°Ô∏è sendData: " + JSON.stringify(payload));

    try {
      tg.sendData(JSON.stringify(payload));
      tg.MainButton.disable();
      tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ");
    } catch (e) {
      log("‚ùå sendData exception: " + (e?.message || e));
      tg.showAlert?.("‚ùå sendData exception");
    }
  }

  // –°–ø–æ—Å–æ–± 1
  tg.MainButton.onClick(() => handleMainButtonClick("MainButton.onClick"));

  // –°–ø–æ—Å–æ–± 2 (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
  tg.onEvent?.("mainButtonClicked", () => handleMainButtonClick("tg.onEvent(mainButtonClicked)"));
</script>

</body>
</html>
