<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Hadamat Taxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: Arial, sans-serif;
}
#map {
  height: calc(100% - 120px);
}
#panel {
  height: 120px;
  padding: 10px;
  background: #fff;
}
button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  background: #00c853;
  color: white;
  border: none;
  border-radius: 8px;
}
button:disabled {
  background: #aaa;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <div id="info">üìç –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ A –∏ B</div>
  <button id="send" disabled>üöï –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<script>
  // üî• –ü–†–û–í–ï–†–ö–ê: –¢–û–õ–¨–ö–û TELEGRAM WEBAPP
  if (!window.Telegram || !Telegram.WebApp || !Telegram.WebApp.initData) {
    document.body.innerHTML = "<h2>‚ùå –û—Ç–∫—Ä—ã—Ç–æ –ù–ï –∏–∑ Telegram</h2>";
    throw new Error("Not Telegram WebApp");
  }

  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  let map, A = null, B = null, distanceKm = null;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 55.4842, lng: 54.8526 }, // –î—é—Ä—Ç—é–ª–∏
      zoom: 13
    });

    const dirService = new google.maps.DirectionsService();
    const dirRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
    dirRenderer.setMap(map);

    map.addListener("click", (e) => {
      if (!A) {
        A = e.latLng;
        new google.maps.Marker({ position: A, map, label: "A" });
      } else if (!B) {
        B = e.latLng;
        new google.maps.Marker({ position: B, map, label: "B" });

        dirService.route({
          origin: A,
          destination: B,
          travelMode: google.maps.TravelMode.DRIVING
        }, (res, status) => {
          if (status === "OK") {
            dirRenderer.setDirections(res);
            distanceKm = (res.routes[0].legs[0].distance.value / 1000).toFixed(2);
            document.getElementById("info").innerText =
              `üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceKm} –∫–º`;
            document.getElementById("send").disabled = false;
          }
        });
      }
    });

    document.getElementById("send").onclick = () => {
      const payload = {
        from: { lat: A.lat(), lng: A.lng() },
        to: { lat: B.lat(), lng: B.lng() },
        distance_km: distanceKm
      };

      tg.sendData(JSON.stringify(payload));
      setTimeout(() => tg.close(), 300);
    };
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATx02KvZ6rWHpa8cHGowTE3bReTyNrp38&callback=initMap">
</script>

</body>
</html>

